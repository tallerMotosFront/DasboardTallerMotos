<div class="appointment-dialog">
  <div class="dialog-header">
    <h2 mat-dialog-title>
      <mat-icon>event_available</mat-icon>
      Agenda tu Cita
    </h2>
    <button mat-icon-button mat-dialog-close class="close-btn">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content>
    <p class="dialog-description">
      Completa el formulario y nos pondremos en contacto contigo para confirmar tu cita.
    </p>

    <form [formGroup]="appointmentForm" class="appointment-form">
      <!-- Información Personal -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>person</mat-icon>
          Información Personal
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre Completo</mat-label>
            <input matInput formControlName="nombre" placeholder="Ej: Juan Pérez">
            <mat-icon matPrefix>person</mat-icon>
            <mat-error *ngIf="appointmentForm.get('nombre')?.hasError('required')">
              El nombre es obligatorio
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Teléfono</mat-label>
            <input matInput formControlName="telefono" placeholder="300 123 4567">
            <mat-icon matPrefix>phone</mat-icon>
            <mat-error *ngIf="appointmentForm.get('telefono')?.hasError('required')">
              El teléfono es obligatorio
            </mat-error>
            <mat-error *ngIf="appointmentForm.get('telefono')?.hasError('pattern')">
              Formato de teléfono inválido
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" type="email" placeholder="ejemplo@correo.com">
            <mat-icon matPrefix>email</mat-icon>
            <mat-error *ngIf="appointmentForm.get('email')?.hasError('required')">
              El email es obligatorio
            </mat-error>
            <mat-error *ngIf="appointmentForm.get('email')?.hasError('email')">
              Email inválido
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Información de la Moto -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>two_wheeler</mat-icon>
          Información de la Moto
        </h3>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Marca</mat-label>
            <mat-select formControlName="marca">
              <mat-option *ngFor="let marca of marcas" [value]="marca">
                {{ marca }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>brand_family</mat-icon>
            <mat-error *ngIf="appointmentForm.get('marca')?.hasError('required')">
              La marca es obligatoria
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Modelo</mat-label>
            <input matInput formControlName="modelo" placeholder="Ej: CB 190">
            <mat-icon matPrefix>motorcycle</mat-icon>
            <mat-error *ngIf="appointmentForm.get('modelo')?.hasError('required')">
              El modelo es obligatorio
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Año</mat-label>
            <input matInput formControlName="anio" type="number" placeholder="2020">
            <mat-icon matPrefix>calendar_today</mat-icon>
            <mat-error *ngIf="appointmentForm.get('anio')?.hasError('required')">
              El año es obligatorio
            </mat-error>
            <mat-error *ngIf="appointmentForm.get('anio')?.hasError('min') || appointmentForm.get('anio')?.hasError('max')">
              Año inválido
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Placa</mat-label>
            <input matInput formControlName="placa" placeholder="ABC123">
            <mat-icon matPrefix>badge</mat-icon>
            <mat-error *ngIf="appointmentForm.get('placa')?.hasError('required')">
              La placa es obligatoria
            </mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Kilometraje Actual</mat-label>
          <input matInput formControlName="kilometraje" type="number" placeholder="15000">
          <mat-icon matPrefix>speed</mat-icon>
          <span matSuffix>km</span>
          <mat-error *ngIf="appointmentForm.get('kilometraje')?.hasError('required')">
            El kilometraje es obligatorio
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Detalles del Servicio -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>build</mat-icon>
          Detalles del Servicio
        </h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tipo de Servicio</mat-label>
          <mat-select formControlName="tipoServicio" multiple>
            <mat-option *ngFor="let servicio of servicios" [value]="servicio">
              {{ servicio }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>settings</mat-icon>
          <mat-error *ngIf="appointmentForm.get('tipoServicio')?.hasError('required')">
            Selecciona al menos un servicio
          </mat-error>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Fecha Preferida</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="fechaPreferida" [min]="minDate">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
            <mat-error *ngIf="appointmentForm.get('fechaPreferida')?.hasError('required')">
              La fecha es obligatoria
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Hora Preferida</mat-label>
            <mat-select formControlName="horaPreferida">
              <mat-option *ngFor="let hora of horas" [value]="hora">
                {{ hora }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>schedule</mat-icon>
            <mat-error *ngIf="appointmentForm.get('horaPreferida')?.hasError('required')">
              La hora es obligatoria
            </mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Describe el problema o servicio requerido</mat-label>
          <textarea 
            matInput 
            formControlName="descripcion" 
            rows="4"
            placeholder="Ej: La moto hace un ruido extraño al acelerar...">
          </textarea>
          <mat-icon matPrefix>description</mat-icon>
          <mat-hint align="end">{{ appointmentForm.get('descripcion')?.value?.length || 0 }}/500</mat-hint>
        </mat-form-field>

        <div class="urgency-selector">
          <label class="urgency-label">
            <mat-icon>priority_high</mat-icon>
            Urgencia del servicio:
          </label>
          <mat-radio-group formControlName="urgencia" class="urgency-options">
            <mat-radio-button value="baja" color="primary">
              <span class="urgency-badge baja">Baja</span>
              <small>Puedo esperar</small>
            </mat-radio-button>
            <mat-radio-button value="media" color="primary">
              <span class="urgency-badge media">Media</span>
              <small>En esta semana</small>
            </mat-radio-button>
            <mat-radio-button value="alta" color="warn">
              <span class="urgency-badge alta">Alta</span>
              <small>Lo antes posible</small>
            </mat-radio-button>
          </mat-radio-group>
        </div>
      </div>

      <!-- Información Adicional -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>info</mat-icon>
          Información Adicional
        </h3>

        <mat-checkbox formControlName="requiereRecogida" color="primary" class="checkbox-option">
          <div class="checkbox-content">
            <strong>Requiero servicio de recogida y entrega a domicilio</strong>
            <small>Servicio adicional con costo extra según ubicación</small>
          </div>
        </mat-checkbox>

        <mat-form-field 
          appearance="outline" 
          class="full-width" 
          *ngIf="appointmentForm.get('requiereRecogida')?.value">
          <mat-label>Dirección de recogida</mat-label>
          <textarea 
            matInput 
            formControlName="direccionRecogida" 
            rows="2"
            placeholder="Calle, número, barrio, ciudad">
          </textarea>
          <mat-icon matPrefix>location_on</mat-icon>
        </mat-form-field>

        <mat-checkbox formControlName="aceptaTerminos" color="primary" class="checkbox-option">
          <div class="checkbox-content">
            <strong>Acepto los términos y condiciones</strong>
            <small>He leído y acepto la <a href="#" class="link">política de privacidad</a></small>
          </div>
        </mat-checkbox>
      </div>
    </form>

    <!-- Summary Card -->
    <mat-card class="summary-card" *ngIf="appointmentForm.valid">
      <mat-card-header>
        <mat-icon mat-card-avatar>check_circle</mat-icon>
        <mat-card-title>Resumen de tu Cita</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-item">
          <strong>Cliente:</strong> {{ appointmentForm.get('nombre')?.value }}
        </div>
        <div class="summary-item">
          <strong>Moto:</strong> {{ appointmentForm.get('marca')?.value }} {{ appointmentForm.get('modelo')?.value }} ({{ appointmentForm.get('anio')?.value }})
        </div>
        <div class="summary-item">
          <strong>Servicios:</strong> {{ appointmentForm.get('tipoServicio')?.value?.join(', ') }}
        </div>
        <div class="summary-item">
          <strong>Fecha:</strong> {{ appointmentForm.get('fechaPreferida')?.value | date:'fullDate':'':'es' }} - {{ appointmentForm.get('horaPreferida')?.value }}
        </div>
        <div class="summary-item">
          <strong>Urgencia:</strong> 
          <span [class]="'urgency-badge ' + appointmentForm.get('urgencia')?.value">
            {{ appointmentForm.get('urgencia')?.value | titlecase }}
          </span>
        </div>
      </mat-card-content>
    </mat-card>

  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close type="button">
      Cancelar
    </button>
    <button 
      mat-raised-button 
      color="primary" 
      [disabled]="appointmentForm.invalid || isSubmitting"
      (click)="submitAppointment()">
      <mat-icon *ngIf="!isSubmitting">send</mat-icon>
      <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
      {{ isSubmitting ? 'Enviando...' : 'Agendar Cita' }}
    </button>
  </mat-dialog-actions>
</div>